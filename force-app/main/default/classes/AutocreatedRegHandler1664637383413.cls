//TODO:This autogenerated class includes the basics for a Registration
//Handler class. You will need to customize it to ensure it meets your needs and
//the data provided by the third party.

global class AutocreatedRegHandler1664637383413 implements Auth.RegistrationHandler{
global boolean canCreateUser(Auth.UserData data) {
	//TODO: Check whether we want to allow creation of a user with this data
	//Set<String> s = new Set<String>{'usernamea', 'usernameb', 'usernamec'};
	//if(s.contains(data.username)) {
		//return true;
	//}
	return true;
}

global User createUser(Id portalId, Auth.UserData data){
    String userName;   
    if(data.attributeMap.containsKey('sfdc_networkid')) {
            userName = data.email;
         }
        List<User> userList = [Select Id, Name, Email, UserName From User 
                                      Where ( Email =: userName)
                                      AND isActive = true
                                      ];
	if(userList != null && userList.size() > 0) {
		 User userdata = userList.get(0);
            return userdata;
	}
    System.debug('data'+Data);
    System.debug('dataemail'+ data.email);
	if(data.attributeMap.containsKey('sfdc_networkid')) {
		//We have a community id, so create a user with community access
		//TODO: Get an actual account
		//
		// Account a = [SELECT Id FROM account WHERE name='Cloud Peritus'];
        
        RecordType contactType =[SELECT Id, Name, IsActive FROM RecordType where Name ='Resource'];
        System.debug('contactType'+contactType);
        Contact contactData =[SELECT Id, LastName,Official_Mail__c, FirstName,email, RecordTypeId FROM Contact where RecordTypeId =: contactType.Id and Official_Mail__c =: data.email];
        
        System.debug('contactData'+contactData);
        
		/* Contact c = new Contact();
		c.accountId = a.Id;
		c.email = data.email;
		c.firstName = data.firstName;
		c.lastName = data.lastName;
		insert(c);   */

		//TODO: Customize the username and profile. Also check that the username doesn't already exist and
		//possibly ensure there are enough org licenses to create a user. Must be 80 characters or less.
		User u;
      //  If (contactData.Email == data.email){
      // if(contactData.Email.equals(data.email)){
		 u = new User();
		Profile p = [SELECT Id FROM profile WHERE name='TM Customer Community'];
            System.debug('Profile'+p);
            
		u.username = data.email;
		u.email = data.email;
		u.lastName = data.lastName;
		u.firstName = data.firstName;
		String alias = data.firstName;
		//Alias must be 8 characters or less
		if(alias.length() > 8) {
			alias = alias.substring(0,5);
		}
		u.alias = alias;
        u.CommunityNickname = data.firstName+ data.lastName;
		u.languagelocalekey = 'en_US';
		u.localesidkey = 'en_US';
		u.emailEncodingKey = 'UTF-8';
		u.timeZoneSidKey = 'America/Los_Angeles';
		u.profileId = p.Id;
		u.contactId = contactData.Id;
            
       Database.DMLOptions dmo = new Database.DMLOptions();
        dmo.EmailHeader.triggerUserEmail = true;       
        dmo.EmailHeader.triggerOtherEmail = true;
        dmo.EmailHeader.triggerAutoResponseEmail = true;       
        dmo.optAllOrNone = false;

        u.setOptions(dmo);   
                       
        Insert u;
        System.debug('User is created'+u);
      // }
		return u;
	} else {
	/*	//This is not a community, so create a regular standard user
		User u = new User();
		Profile p = [SELECT Id FROM profile WHERE name='Standard User'];
		//TODO: Customize the username. Also check that the username doesn't already exist and
		//possibly ensure there are enough org licenses to create a user. Must be 80 characters
		//or less.
		u.username = data.username + '@myorg.com';
		u.email = data.email;
		u.lastName = data.lastName;
		u.firstName = data.firstName;
		String alias = data.username;
		//Alias must be 8 characters or less
		if(alias.length() > 8) {
			alias = alias.substring(0, 8);
		}
		u.alias = alias;
		u.languagelocalekey = UserInfo.getLocale();
		u.localesidkey = UserInfo.getLocale();
		u.emailEncodingKey = 'UTF-8';
		u.timeZoneSidKey = 'America/Los_Angeles';
		u.profileId = p.Id;*/
        System.debug('Null is genrated');
		return null;
	}
}

global void updateUser(Id userId, Id portalId, Auth.UserData data){
	User u = new User(id=userId);
	//TODO: Customize the username. Must be 80 characters or less.
	//u.username = data.username + '@myorg.com';
	u.email = data.email;
	u.lastName = data.lastName;
	u.firstName = data.firstName;
	//String alias = data.username;
	//Alias must be 8 characters or less
	//if(alias.length() > 8) {
		//alias = alias.substring(0, 8);
	//}
	//u.alias = alias;
	update(u);
}
}